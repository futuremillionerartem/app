<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Купить за Stars</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-button {
            background-image: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(79, 172, 254, 0.4);
        }
        .gradient-button:hover {
            background-position: right center;
            box-shadow: 0 6px 20px 0 rgba(79, 172, 254, 0.6);
        }
        .gradient-button:active { transform: scale(0.95); }
        .gradient-button:disabled {
             background-image: linear-gradient(to right, #a0aec0 0%, #cbd5e0 100%);
             cursor: not-allowed;
             opacity: 0.6;
             box-shadow: none;
        }
        /* Стили для индикатора загрузки */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4facfe; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto; /* Центрирование */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">

    <div class="flex flex-col items-center justify-center min-h-screen text-center p-4">

        <div id="loader" class="loader mb-4 hidden"></div>

        <button id="buyButton" class="gradient-button text-white font-bold py-4 px-10 rounded-full text-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-cyan-500" disabled>
            BUYY (100 Stars)
        </button>

        <p id="infoMessage" class="mt-4 text-gray-400 text-sm"></p>

    </div>

    <div id="errorMessage" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg text-center hidden z-50">
    </div>

    <script>
        const buyButton = document.getElementById('buyButton');
        const errorMessage = document.getElementById('errorMessage');
        const infoMessage = document.getElementById('infoMessage');
        const loader = document.getElementById('loader');

        // --- ВАЖНО: Укажите URL вашего бэкэнда ---
        const BACKEND_URL = 'https://server-red-nu-83.vercel.app'; // Базовый URL
        const INVOICE_ENDPOINT = '/create-invoice'; // Эндпоинт для создания счета
        // -----------------------------------------

        let invoiceSlug = null; // Переменная для хранения slug

        // Функция для отображения ошибок
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000); // Скрыть через 5 сек
        }

        // Функция для получения slug с бэкэнда
        async function fetchInvoiceSlug() {
            console.log('Запрос slug с бэкэнда...');
            loader.classList.remove('hidden'); // Показать индикатор загрузки
            buyButton.disabled = true; // Деактивировать кнопку на время запроса
            infoMessage.textContent = 'Подготовка счета...';

            try {
                // --- ИСПРАВЛЕНО: Обращаемся к правильному эндпоинту ---
                const response = await fetch(BACKEND_URL + INVOICE_ENDPOINT);
                // -----------------------------------------------------

                if (!response.ok) {
                    // Попытка прочитать тело ошибки от бэкенда
                    let errorDetails = 'Не удалось получить данные от сервера.';
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.error || errorDetails;
                        if (errorData.details) {
                             errorDetails += ` (${errorData.details})`;
                        }
                    } catch (e) { /* Игнорируем ошибку парсинга JSON ответа */ }
                    throw new Error(`Ошибка сети: ${response.status} ${response.statusText}. ${errorDetails}`);
                }

                const data = await response.json();

                if (data.invoiceUrl) {
                    // Извлекаем slug из URL (он находится после 't.me/invoice/')
                    const urlParts = data.invoiceUrl.split('/');
                    invoiceSlug = urlParts[urlParts.length - 1]; // Последняя часть URL - это slug
                    console.log('Slug успешно получен:', invoiceSlug);
                    buyButton.disabled = false; // Активировать кнопку
                    infoMessage.textContent = ''; // Очистить инфо-сообщение
                } else {
                    throw new Error('Некорректный ответ от бэкэнда: отсутствует invoiceUrl.');
                }

            } catch (error) {
                console.error('Ошибка при получении slug:', error);
                showError(`Ошибка получения счета: ${error.message}`);
                infoMessage.textContent = 'Не удалось подготовить счет.';
                 // Оставляем кнопку неактивной
            } finally {
                 loader.classList.add('hidden'); // Скрыть индикатор загрузки
            }
        }

        // --- Инициализация приложения ---
        try {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand(); // Раскрыть на весь экран для лучшего вида

            // Проверяем, запущено ли приложение в Telegram
            if (!Telegram.WebApp.initData) {
                throw new Error('Приложение должно быть запущено внутри Telegram.');
            }

            // Запрашиваем slug при загрузке
            fetchInvoiceSlug();

        } catch (error) {
            console.error("Ошибка инициализации:", error);
            showError(error.message || 'Ошибка инициализации Telegram Web App.');
            buyButton.style.display = 'none'; // Скрыть кнопку, если не в Telegram
            infoMessage.textContent = 'Пожалуйста, откройте это приложение внутри Telegram.';
            loader.classList.add('hidden');
        }

        // --- Обработчик клика по кнопке ---
        buyButton.addEventListener('click', () => {
            console.log('Кнопка "BUY" нажата');

            if (!invoiceSlug) {
                showError('Ошибка: Slug счета не был получен. Попробуйте перезагрузить.');
                console.error('Попытка оплаты без slug.');
                return;
            }

            if (Telegram.WebApp && Telegram.WebApp.openInvoice) {
                try {
                    console.log(`Открытие счета с slug: ${invoiceSlug}`);
                    Telegram.WebApp.openInvoice(invoiceSlug, (status) => {
                        console.log('Статус платежа:', status);
                        if (status === 'paid') {
                            // Важно: Реальная проверка и предоставление доступа
                            // должны происходить на бэкенде через вебхуки!
                            // Здесь можно показать сообщение об успехе.
                            Telegram.WebApp.showPopup({
                                title: 'Успех!',
                                message: 'Оплата прошла успешно! Спасибо.',
                                buttons: [{ type: 'ok' }]
                            });
                            // Можно закрыть Mini App после успеха
                            // Telegram.WebApp.close();
                        } else if (status === 'cancelled') {
                            console.log('Платеж отменен.');
                            // Можно показать сообщение, если нужно
                        } else if (status === 'failed') {
                            showError('Ошибка платежа. Попробуйте снова.');
                        } else if (status === 'pending') {
                            console.log('Платеж в обработке.');
                            // Обычно не требует действий на фронте
                        }
                    });
                } catch (error) {
                    console.error("Ошибка при вызове openInvoice:", error);
                    showError('Не удалось инициировать платеж. Попробуйте позже.');
                }
            } else {
                console.error('Telegram.WebApp.openInvoice не доступен.');
                showError('Ошибка: Функция оплаты доступна только в Telegram.');
            }
        });

    </script>

</body>
</html>
